<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Financeiro Pessoal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --positive-color: #27ae60;
            --negative-color: #e74c3c;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            background-color: #f5f6f8;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .category-sidebar {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .financial-grid {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .balance-chart {
            margin-top: 2rem;
            padding: 1rem;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 600px;
        }

        th, td {
            padding: 12px;
            text-align: right;
            border: 1px solid #e0e0e0;
            min-width: 120px;
        }

        .running-balance td {
            font-weight: 600;
        }

        .positive { color: var(--positive-color); }
        .negative { color: var(--negative-color); }

        .category-management button {
            width: 100%;
            margin: 8px 0;
            padding: 12px;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .category-management button:hover {
            opacity: 0.9;
        }

        input[type="number"] {
            width: 100%;
            text-align: right;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 14px;
            padding: 4px;
        }

        #categoryModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 90%;
            max-width: 400px;
            z-index: 100;
        }

        #categoryModal h3 {
            margin-bottom: 16px;
        }

        #categoryModal input,
        #categoryModal select {
            width: 100%;
            margin: 8px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        #categoryModal button {
            margin-top: 16px;
            padding: 12px;
            width: 48%;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        #categoryModal button:last-child {
            background: #f0f0f0;
        }

        @media (min-width: 768px) {
            .container {
                grid-template-columns: 250px 1fr;
            }
            
            .category-sidebar {
                position: sticky;
                top: 1rem;
                height: fit-content;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="category-sidebar">
            <div class="category-management">
                <h3>Categorias</h3>
                <button onclick="showAddCategoryModal()">+ Nova Categoria</button>
                <div id="categoryList"></div>
            </div>
        </div>

        <div class="financial-grid">
            <table id="financialTable">
                <thead id="tableHeader"></thead>
                <tbody id="tableBody"></tbody>
                <tfoot id="tableFooter"></tfoot>
            </table>
            <div class="balance-chart">
                <canvas id="balanceChart"></canvas>
            </div>
        </div>
    </div>

    <div id="categoryModal">
        <h3>Gerenciar Categoria</h3>
        <input type="text" id="categoryName" placeholder="Nome da categoria">
        <select id="categoryType">
            <option value="income">Receita</option>
            <option value="expense">Despesa</option>
        </select>
        <button onclick="saveCategory()">Salvar</button>
        <button onclick="closeModal()">Cancelar</button>
    </div>

<script>
let balanceChart = null;
const state = {
    categories: [],
    months: []
};

function init() {
    generateMonths();
    loadCategories();
    renderGrid();
}

function generateMonths() {
    const today = new Date();
    state.months = Array.from({ length: 12 }, (_, i) => {
        const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
        return {
            id: date.toISOString(),
            name: date.toLocaleString('pt-BR', { month: 'short' }) + ' ' + date.getFullYear().toString().slice(-2),
            isCurrent: i === 0
        };
    });
}

function loadCategories() {
    try {
        state.categories = localStorage.getItem('categories') 
            ? JSON.parse(localStorage.getItem('categories'))
            : [
                { 
                    id: 1, 
                    name: 'Salário', 
                    type: 'income', 
                    values: Array(12).fill(5000) 
                },
                { 
                    id: 2, 
                    name: 'Aluguel', 
                    type: 'expense', 
                    values: Array(12).fill(2000) 
                }
            ];
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
        state.categories = [];
    }
    renderCategoryList();
}

function showAddCategoryModal(editId = null) {
    state.selectedCategory = editId ? 
        state.categories.find(c => c.id === editId) : 
        null;
    
    const modal = document.getElementById('categoryModal');
    modal.style.display = 'block';
    
    if(state.selectedCategory) {
        document.getElementById('categoryName').value = state.selectedCategory.name;
        document.getElementById('categoryType').value = state.selectedCategory.type;
    } else {
        document.getElementById('categoryName').value = '';
        document.getElementById('categoryType').value = 'income';
    }
}

function saveCategory() {
    const name = document.getElementById('categoryName').value.trim();
    const type = document.getElementById('categoryType').value;
    
    if(!name) {
        alert('Por favor insira um nome para a categoria');
        return;
    }
    
    if(state.selectedCategory) {
        state.selectedCategory.name = name;
        state.selectedCategory.type = type;
    } else {
        state.categories.push({
            id: Date.now(),
            name,
            type,
            values: Array(12).fill(0)
        });
    }
    
    saveState();
    closeModal();
    renderGrid();
    renderCategoryList();
}

function closeModal() {
    document.getElementById('categoryModal').style.display = 'none';
    state.selectedCategory = null;
}

function renderCategoryList() {
    const list = document.getElementById('categoryList');
    list.innerHTML = state.categories.map(c => `
        <div class="category-item" style="margin: 8px 0; padding: 12px; background: #f8f9fa; border-radius: 6px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>${c.name} (${c.type === 'income' ? '➕ Receita' : '➖ Despesa'})</span>
                <button onclick="showAddCategoryModal(${c.id})" 
                        style="padding: 4px 8px; background: #e0e0e0; border: none; border-radius: 4px;">
                    Editar
                </button>
            </div>
        </div>
    `).join('');
}

function renderGrid() {
    const header = document.getElementById('tableHeader');
    const body = document.getElementById('tableBody');
    const footer = document.getElementById('tableFooter');

    // Renderizar cabeçalho
    header.innerHTML = `
        <tr>
            <th style="text-align: left;">Categoria</th>
            ${state.months.map(m => `
                <th style="min-width: 100px;">${m.name}</th>
            `).join('')}
        </tr>
    `;

    // Renderizar corpo
    body.innerHTML = state.categories.map(category => `
        <tr>
            <td style="text-align: left;">${category.name}</td>
            ${category.values.map((value, index) => `
                <td>
                    <input type="number" 
                           value="${value !== 0 ? value : ''}"
                           onchange="updateValue(${category.id}, ${index}, this.value)"
                           placeholder="0,00"
                           step="0.01"
                           style="width: 100%; padding: 4px;">
                </td>
            `).join('')}
        </tr>
    `).join('');

    // Calcular e renderizar saldos
    const balances = calculateRunningBalances();
    footer.innerHTML = `
        <tr class="running-balance">
            <td style="text-align: left; font-weight: 600;">Saldo Projetado</td>
            ${balances.map(balance => `
                <td class="${balance >= 0 ? 'positive' : 'negative'}">
                    ${formatCurrency(balance)}
                </td>
            `).join('')}
        </tr>
    `;

    renderBalanceChart();
}

function updateValue(categoryId, monthIndex, value) {
    const category = state.categories.find(c => c.id === categoryId);
    category.values[monthIndex] = parseFloat(value.replace(',', '.')) || 0;
    saveState();
    renderGrid();
}

function calculateRunningBalances() {
    let runningBalance = 0;
    return state.months.map((_, index) => {
        const income = state.categories
            .filter(c => c.type === 'income')
            .reduce((sum, c) => sum + (c.values[index] || 0), 0);
        
        const expenses = state.categories
            .filter(c => c.type === 'expense')
            .reduce((sum, c) => sum + (c.values[index] || 0), 0);
        
        runningBalance += (income - expenses);
        return runningBalance;
    });
}

function renderBalanceChart() {
    const ctx = document.getElementById('balanceChart').getContext('2d');
    const balances = calculateRunningBalances();
    const labels = state.months.map(m => m.name);

    if (balanceChart) balanceChart.destroy();

    balanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                data: balances,
                borderColor: '#2c3e50',
                backgroundColor: 'rgba(44, 62, 80, 0.05)',
                tension: 0.3,
                borderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: (context) => `Saldo: ${formatCurrency(context.parsed.y)}`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: '#f0f0f0' },
                    ticks: {
                        callback: (value) => formatCurrency(value),
                        maxTicksLimit: 6
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: { maxRotation: 0 }
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
}

function formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value);
}

function saveState() {
    localStorage.setItem('categories', JSON.stringify(state.categories));
}

// Inicializar aplicação
init();

// Configurar redimensionamento responsivo
window.addEventListener('resize', () => {
    if (balanceChart) {
        balanceChart.resize();
    }
});
</script>
</body>
</html>
