<!DOCTYPE html>
<html>
<head>
  <title>Sistema de Pastas Corrigido</title>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.2/firebase-storage-compat.js"></script>
</head>
<body>
  <h1>Sistema de Pastas e Arquivos</h1>
  
  <!-- Criar pastas -->
  <div>
    <input type="text" id="folderName" placeholder="Nome da pasta">
    <button onclick="createFolder()">Criar Pasta</button>
  </div>

  <!-- Upload para pasta -->
  <div>
    <select id="selectedFolder">
      <option value="">Selecione uma pasta</option>
    </select>
    <input type="file" id="fileInput">
    <button onclick="uploadFile()">Enviar para Pasta</button>
  </div>

  <!-- Listagem de pastas -->
  <div id="foldersList"></div>

  <script>
 const firebaseConfig = {
  apiKey: "AIzaSyDFw39E7f8TQPNlDVKrj5861_FMG_YqCy4",
  authDomain: "finance-ef792.firebaseapp.com",
  databaseURL: "https://finance-ef792-default-rtdb.firebaseio.com",
  projectId: "finance-ef792",
  storageBucket: "finance-ef792.firebasestorage.app",
  messagingSenderId: "67228742612",
  appId: "1:67228742612:web:fa2480d939bda6f18f1c41"
};
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();

    // Criar pasta (corrigido)
    function createFolder() {
      const folderName = document.getElementById('folderName').value.trim();
      if (!folderName) return;

      // Verifica se a pasta j√° existe
      const foldersRef = database.ref('folders');
      foldersRef.orderByChild('name').equalTo(folderName).once('value', (snapshot) => {
        if (!snapshot.exists()) {
          foldersRef.push({
            name: folderName,
            created: firebase.database.ServerValue.TIMESTAMP
          });
        }
      });
      
      document.getElementById('folderName').value = '';
    }

    // Upload de arquivo (corrigido)
    async function uploadFile() {
      const file = document.getElementById('fileInput').files[0];
      const folderId = document.getElementById('selectedFolder').value;
      
      if (!file || !folderId) {
        alert('Selecione um arquivo e uma pasta!');
        return;
      }

      try {
        // Obt√©m os dados da pasta
        const folderSnapshot = await database.ref(`folders/${folderId}`).once('value');
        const folderName = folderSnapshot.val().name;

        // Upload para Storage
        const storageRef = storage.ref(`folders/${folderId}/${file.name}`);
        await storageRef.put(file);
        const downloadURL = await storageRef.getDownloadURL();

        // Salva metadados no Realtime Database
        await database.ref(`folders/${folderId}/files`).push().set({
          name: file.name,
          url: downloadURL,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        alert('Arquivo enviado com sucesso!');
      } catch (error) {
        console.error('Erro no upload:', error);
        alert('Erro ao enviar arquivo!');
      }
    }

    // Atualizar lista de pastas (corrigido)
    function setupFolders() {
      const foldersRef = database.ref('folders');
      
      // Atualiza o dropdown
      foldersRef.on('value', (snapshot) => {
        const select = document.getElementById('selectedFolder');
        select.innerHTML = '<option value="">Selecione uma pasta</option>';
        
        snapshot.forEach((child) => {
          const option = document.createElement('option');
          option.value = child.key;
          option.textContent = child.val().name;
          select.appendChild(option);
        });
      });

      // Atualiza a listagem visual
      foldersRef.on('child_added', (child) => {
        const folder = child.val();
        const folderDiv = document.createElement('div');
        folderDiv.id = `folder-${child.key}`;
        folderDiv.innerHTML = `
          <h3>üìÅ ${folder.name}</h3>
          <div class="files" id="files-${child.key}"></div>
        `;
        
        document.getElementById('foldersList').appendChild(folderDiv);
        
        // Monitora arquivos da pasta
        database.ref(`folders/${child.key}/files`).on('child_added', (fileChild) => {
          const file = fileChild.val();
          const fileElement = document.createElement('div');
          fileElement.innerHTML = `
            üìÑ ${file.name} 
            <a href="${file.url}" download>Download</a>
          `;
          document.getElementById(`files-${child.key}`).appendChild(fileElement);
        });
      });
    }

    // Inicializa√ß√£o
    window.onload = () => {
      setupFolders();
    };
  </script>

  <style>
    /* Estilos b√°sicos para melhor visualiza√ß√£o */
    body { font-family: Arial, sans-serif; padding: 20px; }
    div { margin: 10px 0; }
    .files { margin-left: 25px; border-left: 2px solid #ccc; padding-left: 10px; }
    h3 { color: #333; cursor: pointer; }
    a { color: blue; text-decoration: underline; }
  </style>
</body>
</html>
